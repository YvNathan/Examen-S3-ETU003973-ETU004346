Exemple
CREATE OR REPLACE PROCEDURE proc_rent_film(p_customer_id INT, p_film_id INT)
LANGUAGE plpgsql
AS $$
DECLARE
v_inventory_id INT;
v_staff_id INT := 1; -- staff par défaut
v_rental_id INT;
v_amount NUMERIC(10,2);
v_film_title TEXT;
BEGIN


-- Vérifier que le client existe
IF NOT EXISTS (SELECT 1 FROM customer WHERE customer_id = p_customer_id) THEN
RAISE EXCEPTION 'Client % inexistant', p_customer_id;
END IF;


-- Vérifier que le film existe et récupérer des infos
SELECT film_id, title, rental_rate
INTO v_inventory_id, v_film_title, v_amount
FROM film
WHERE film_id = p_film_id;
IF NOT FOUND THEN
RAISE EXCEPTION 'Film % inexistant', p_film_id;
END IF;


-- Trouver un inventory disponible
SELECT inventory_id
INTO v_inventory_id
FROM inventory
WHERE film_id = p_film_id
LIMIT 1;
IF v_inventory_id IS NULL THEN
RAISE EXCEPTION 'Aucun exemplaire disponible pour le film %', v_film_title;
END IF;


-- Début d’une mini-transaction interne
BEGIN
-- Insert dans rental
INSERT INTO rental (rental_date, inventory_id, customer_id, staff_id)
VALUES (NOW(), v_inventory_id, p_customer_id, v_staff_id)
RETURNING rental_id INTO v_rental_id;
-- Insert dans payment
INSERT INTO payment (customer_id, staff_id, rental_id, amount, payment_date)
VALUES (p_customer_id, v_staff_id, v_rental_id, v_amount, NOW());
EXCEPTION WHEN OTHERS THEN
RAISE EXCEPTION 'Erreur interne lors de la location du film: %', SQLERRM;
END;
-- Feedback
RAISE NOTICE 'Client % a loué le film % (rental_id = %)',
p_customer_id, v_film_title, v_rental_id;
END;
$$;

Appel de la procédure
CALL proc_rent_film(25, 120);
